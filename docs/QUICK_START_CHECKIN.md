# 康复视频打卡功能 - 快速开始指南

## 🎯 功能概述

本系统根据患者的膝关节骨关节炎分期（I-IV期），自动推荐个性化的康复训练视频，并提供打卡、进度跟踪、积分奖励和成就系统。

---

## 🚀 快速开始（5步搞定）

### 步骤 1：部署云函数

在 HBuilderX 中，右键以下云函数目录并选择"上传部署"：

```
uniCloud-aliyun/cloudfunctions/
├── initRehabVideos       ✅ 视频管理云函数
├── createRehabPlan       ✅ 创建康复计划
├── getRehabPlan          ✅ 获取康复计划  
└── trainingCheckIn       ✅ 训练打卡
```

**验证部署**：在 uniCloud 控制台查看云函数列表，确认4个函数状态为"运行中"。

---

### 步骤 2：创建数据库集合

在 uniCloud 控制台 → 云数据库 → 新建集合，创建以下4个集合：

| 集合名称 | 用途 | 必需 |
|---------|------|------|
| `rehabilitation_videos` | 康复视频库 | ✅ |
| `rehabilitation_plans` | 用户训练计划 | ✅ |
| `training_check_ins` | 打卡记录 | ✅ |
| `user_rehabilitation_profiles` | 用户康复档案 | ✅ |

**注意**：集合名称必须完全一致，包括下划线。

---

### 步骤 3：添加康复视频

#### 方法A：使用视频管理后台（推荐）

1. **访问视频管理页面**
   ```
   路径：pages/admin/init-videos
   或在小程序中访问：/pages/admin/init-videos
   ```

2. **添加抖音视频**
   - 打开抖音APP，找到康复训练视频
   - 点击分享 → 复制链接
   - 在视频管理页面填写：
     - 视频标题：`膝关节康复训练 - I期基础动作`
     - 视频描述：`适合早期骨关节炎患者...`
     - 视频来源：选择"抖音链接"
     - 粘贴抖音链接
     - 时长（秒）：`300`
     - 难度：选择"简单"
     - 类别：选择"柔韧性"
     - 分期：勾选 ☑ I期
   - 点击"添加视频"

3. **推荐视频配置**（至少添加以下数量）：
   - **I期视频**：6-8个（简单难度，柔韧性训练）
   - **II期视频**：8-10个（简单+中等，力量+平衡）
   - **III期视频**：6个（简单难度，温和训练）
   - **IV期视频**：4-5个（简单难度，轻柔活动）

#### 方法B：在uniCloud控制台直接导入

在 `rehabilitation_videos` 集合中新增文档，使用以下格式：

```json
{
  "title": "膝关节康复训练 - I期股四头肌激活",
  "description": "适合I期患者的基础训练，包括股四头肌等长收缩等",
  "videoUrl": "https://v.douyin.com/ieFxxxxxx/",
  "thumbnailUrl": "",
  "duration": 420,
  "difficulty": "easy",
  "category": "flexibility",
  "targetStage": ["I"],
  "precautions": ["动作幅度适中", "如有疼痛立即停止"],
  "createdAt": { "$date": "2025-10-24T00:00:00.000Z" },
  "views": 0,
  "completions": 0,
  "isActive": true
}
```

---

### 步骤 4：测试完整流程

#### 4.1 创建诊断记录

1. 小程序首页 → 点击"图像诊断"
2. 上传膝关节MRI图像
3. 点击"开始诊断"
4. 查看诊断结果（会显示I/II/III/IV期）
5. 点击"保存结果"

#### 4.2 创建康复计划

诊断保存后，会弹出提示：
```
是否根据诊断结果创建个性化康复训练计划？
[取消] [立即创建]
```
点击"立即创建"，系统自动：
- 根据分期筛选合适的视频
- 生成训练计划（包含每周目标）
- 跳转到康复训练页面

#### 4.3 查看训练计划

康复训练页面会显示：
- **进度卡片**：当前周次、完成度
- **统计数据**：本周打卡、累计打卡、连续天数
- **推荐视频列表**：根据分期推荐的视频
- **康复目标**：该分期的训练目标

#### 4.4 观看视频并打卡

1. 点击任意视频卡片
2. 进入视频播放页面
3. 观看训练视频（至少观看30%才能打卡）
4. 点击"完成打卡"按钮
5. 填写反馈：
   - **难度感受**：1-5星评分
   - **疼痛程度**：1-5星评分
   - **训练笔记**：（选填）记录感受
6. 点击"完成打卡 +10积分"
7. 打卡成功！获得：
   - 10积分
   - 连续打卡天数+1
   - 可能解锁成就（如连续7天）

---

## 📋 分期推荐规则

系统会根据诊断分期自动推荐视频：

### I期（早期骨关节炎）
```yaml
难度: 简单
类别: 柔韧性为主
视频数量: 6个
每周目标: 5次训练
训练周期: 12周
推荐动作:
  - 股四头肌等长收缩
  - 踝泵运动
  - 直腿抬高
  - 关节活动度训练
```

### II期（轻度骨关节炎）
```yaml
难度: 简单 + 中等
类别: 力量 + 柔韧性 + 平衡
视频数量: 8个
每周目标: 5次训练
训练周期: 12周
推荐动作:
  - 坐姿膝关节屈伸
  - 直腿抬高（进阶版）
  - 靠墙静蹲
  - 单腿平衡训练
```

### III期（中度骨关节炎）
```yaml
难度: 简单
类别: 柔韧性
视频数量: 6个
每周目标: 3次训练
训练周期: 8周
推荐动作:
  - 温和的关节活动
  - 坐位训练
  - 辅助行走训练
```

### IV期（重度骨关节炎）
```yaml
难度: 简单
类别: 轻柔活动
视频数量: 4个
每周目标: 3次训练
训练周期: 8周
推荐动作:
  - 被动关节活动
  - 坐位轻柔训练
  - 辅助器械训练
```

---

## 🎮 成就系统

### 解锁条件

| 成就名称 | 解锁条件 | 奖励 |
|---------|---------|------|
| 坚持不懈 | 连续打卡7天 | 特殊徽章 |
| 康复达人 | 连续打卡30天 | 金色徽章 |
| 训练勇士 | 累计打卡50次 | 称号 |
| 康复专家 | 累计打卡100次 | 高级称号 |

### 积分规则

- 每次打卡：+10积分
- 连续打卡加成：连续7天+50积分
- 完成周目标：+30积分

---

## 🔧 常见问题排查

### Q1：没有推荐视频
**原因**：数据库中没有对应分期的视频  
**解决**：
1. 检查 `rehabilitation_videos` 集合是否有数据
2. 确认视频的 `targetStage` 字段包含对应分期（如 `["I"]`）
3. 确认视频的 `difficulty` 符合该分期要求

### Q2：创建计划失败
**原因**：云函数未部署或数据库集合未创建  
**解决**：
1. 检查云函数 `createRehabPlan` 是否已部署
2. 确认4个数据库集合都已创建
3. 查看云函数日志排查错误

### Q3：打卡按钮不可点击
**原因**：观看进度不足30%  
**解决**：
- 继续观看视频至少到30%进度
- 或直接拖动进度条到30%以上

### Q4：抖音视频无法播放
**原因**：链接失效或视频私密  
**解决**：
1. 重新获取最新的抖音分享链接
2. 确认视频为公开状态
3. 考虑将视频下载后上传到云存储

### Q5：测试模式下的用户ID
**功能**：未登录用户可使用测试模式  
**测试用户ID**：`test_user_demo`
- 打卡数据会保存
- 但账号切换后数据不互通

---

## 📊 数据库结构参考

### rehabilitation_videos（康复视频库）
```javascript
{
  _id: String,
  title: String,              // 视频标题
  description: String,        // 描述
  videoUrl: String,          // 视频URL（抖音链接或云存储）
  thumbnailUrl: String,      // 缩略图（可选）
  duration: Number,          // 时长（秒）
  difficulty: String,        // easy/medium/hard
  targetStage: Array,        // ["I", "II"] 适用分期
  category: String,          // flexibility/strength/balance
  precautions: Array,        // 注意事项
  views: Number,             // 观看次数
  completions: Number,       // 完成次数
  isActive: Boolean          // 是否启用
}
```

---

## 🎉 从零到上线检查清单

- [ ] **云函数部署**（4个云函数全部部署）
- [ ] **数据库创建**（4个集合全部创建）
- [ ] **视频添加**（至少每个分期3个视频）
- [ ] **诊断测试**（完成一次MRI诊断）
- [ ] **计划创建**（诊断后创建康复计划）
- [ ] **视频播放**（确认视频能正常播放）
- [ ] **打卡测试**（完成一次完整打卡流程）
- [ ] **积分验证**（确认获得10积分）
- [ ] **连续天数**（确认连续天数计算正确）

---

## 📞 技术支持

### 查看日志

- **云函数日志**：uniCloud控制台 → 云函数 → 日志
- **前端日志**：微信开发者工具 → Console
- **数据库查询**：uniCloud控制台 → 云数据库

### 联系开发者

如遇到问题，请提供：
1. 问题描述
2. 操作步骤
3. 错误截图/日志
4. 用户ID和诊断分期

---

## 🔗 相关文档

- [抖音视频添加详细指南](./DOUYIN_VIDEO_GUIDE.md)
- [康复训练系统部署指南](./REHABILITATION_SETUP.md)
- [项目完整结构说明](../PROJECT_STRUCTURE.md)

---

**文档更新时间**：2025-10-24  
**版本**：v1.0  
**适用系统**：AI Doctor 康复训练打卡系统
