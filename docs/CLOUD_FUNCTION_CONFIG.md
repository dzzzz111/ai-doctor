# 云函数环境变量配置指南

## 问题描述
在开发环境中遇到以下错误：
1. "微信登录请使用真实生成环境下的云函数调用进行"
2. "数据库验证失败：["dataDate"]必填"

## 解决方案

### 1. 微信登录云函数配置

#### 错误原因
云函数中未配置真实的微信小程序AppID和AppSecret，导致无法调用微信API。

#### 配置步骤

1. **获取微信小程序凭证**
   - 登录[微信公众平台](https://mp.weixin.qq.com/)
   - 选择你的小程序
   - 进入"开发" → "开发管理" → "开发设置"
   - 复制AppID和AppSecret

2. **在uniCloud控制台配置环境变量**

   进入uniCloud控制台，找到 `wechatLogin` 云函数：

   ```
   环境变量配置：
   WECHAT_APP_ID=wx你的AppID
   WECHAT_APP_SECRET=你的AppSecret
   ```

3. **重新上传云函数**
   ```bash
   # 在HBuilderX中右键点击wechatLogin云函数
   # 选择"上传云函数"
   ```

#### 模拟登录模式
如果暂时没有真实AppID，云函数会自动使用模拟登录模式：
- 生成模拟用户信息
- 普通会员显示"永久有效"
- 不需要真实的微信API调用

### 2. 健康数据数据库配置

#### 错误原因
保存健康数据到云数据库时，缺少必填的`dataDate`字段。

#### 已修复内容
- ✅ 确保所有字段类型正确（dataDate为Date类型）
- ✅ 确保必填字段都有值
- ✅ 优化错误处理，单个数据失败不影响其他数据
- ✅ 添加用户未登录检查

#### 数据库表结构
```json
{
  "userId": "用户ID（必填）",
  "dataDate": "日期（必填，Date类型）",
  "provider": "数据提供商",
  "type": "数据类型",
  "value": "数值（必填）",
  "unit": "单位",
  "syncTime": "同步时间",
  "isValid": "数据有效性"
}
```

### 3. 开发环境配置建议

#### 环境区分
开发环境可以使用模拟数据，生产环境需要配置真实API：

```javascript
// config/cloud-config.js
const cloudConfig = {
  wechat: {
    development: {
      appId: '开发环境AppID',
      appSecret: '开发环境AppSecret'
    },
    production: {
      appId: '生产环境AppID',
      appSecret: '生产环境AppSecret'
    }
  }
}
```

#### 环境变量配置清单

**wechatLogin云函数**：
```
WECHAT_APP_ID=wx你的小程序AppID
WECHAT_APP_SECRET=你的小程序AppSecret
```

**getHealthData云函数**（可选）：
```
XIAOMI_APP_ID=小米健康AppID
XIAOMI_APP_SECRET=小米健康AppSecret
HUAWEI_APP_ID=华为健康AppID
HUAWEI_APP_SECRET=华为健康AppSecret
```

### 4. 测试验证

#### 微信登录测试
1. 不配置环境变量：使用模拟登录
2. 配置环境变量：使用真实微信登录
3. 检查登录用户信息中的vipEndDate字段

#### 健康数据测试
1. 点击"同步数据"按钮
2. 检查控制台日志
3. 验证数据库中是否正确保存数据

### 5. 故障排除

#### 常见问题及解决方案

**问题1：云函数调用失败**
```
错误：function not found
解决：确认云函数已上传成功，名称正确
```

**问题2：环境变量未生效**
```
错误：仍然使用模拟登录
解决：重新上传云函数，检查环境变量名称
```

**问题3：数据库权限错误**
```
错误：Permission denied
解决：检查uniCloud数据库权限配置
```

**问题4：数据类型错误**
```
错误：数据库验证失败
解决：确保dataDate是Date类型，value是字符串
```

### 6. 生产环境部署清单

#### 必需配置
- [ ] 配置微信小程序AppID和AppSecret
- [ ] 上传所有云函数到生产环境
- [ ] 创建数据库表并应用schema
- [ ] 配置数据库权限
- [ ] 测试完整登录流程
- [ ] 测试健康数据同步功能

#### 可选配置
- [ ] 配置小米健康API
- [ ] 配置华为健康API
- [ ] 设置定时任务
- [ ] 配置监控告警

### 7. 安全注意事项

#### 敏感信息保护
- AppSecret不要提交到代码仓库
- 使用环境变量存储敏感配置
- 定期更换AppSecret

#### 数据安全
- 用户数据加密传输
- 数据库访问权限控制
- 定期备份数据

### 8. 监控和维护

#### 日志监控
- 监控云函数执行日志
- 关注错误率和响应时间
- 设置异常告警

#### 数据质量
- 定期检查数据完整性
- 验证数据格式正确性
- 清理无效数据

---

## 快速修复步骤

如果遇到当前错误，请按以下步骤操作：

### 步骤1：修复微信登录（临时方案）
1. 重新上传 `wechatLogin` 云函数
2. 使用模拟登录模式继续开发

### 步骤2：修复健康数据保存（已完成）
1. 健康数据保存逻辑已优化
2. 数据类型验证已修复
3. 错误处理已完善

### 步骤3：生产环境配置（正式部署前）
1. 获取真实的微信小程序AppID和AppSecret
2. 在uniCloud控制台配置环境变量
3. 重新上传云函数
4. 进行完整测试

---

*更新时间：2023年12月*