# ğŸ“‹ MRIè¯Šæ–­è®°å½•ä¿å­˜åŠŸèƒ½ - å®ç°è¯´æ˜

## âœ… å·²å®ŒæˆåŠŸèƒ½

### 1. äº‘å‡½æ•°ï¼ˆ3ä¸ªï¼‰

#### saveDiagnosisRecord
- **è·¯å¾„**ï¼š`uniCloud-aliyun/cloudfunctions/saveDiagnosisRecord/index.js`
- **åŠŸèƒ½**ï¼šä¿å­˜è¯Šæ–­è®°å½•åˆ°äº‘æ•°æ®åº“
- **è¾“å…¥å‚æ•°**ï¼š
  ```javascript
  {
    userId: String,        // ç”¨æˆ·ID
    diagnosisType: String, // è¯Šæ–­ç±»å‹
    imageUrl: String,      // å›¾åƒURL
    result: Object,        // è¯Šæ–­ç»“æœ
    stage: String,         // åˆ†æœŸ (I/II/III/IV)
    confidence: Number     // ç½®ä¿¡åº¦
  }
  ```
- **è¿”å›æ•°æ®**ï¼š
  ```javascript
  {
    code: 0,
    message: 'ä¿å­˜æˆåŠŸ',
    data: {
      diagnosisId: String,
      createdAt: Date
    }
  }
  ```

#### getDiagnosisHistory
- **è·¯å¾„**ï¼š`uniCloud-aliyun/cloudfunctions/getDiagnosisHistory/index.js`
- **åŠŸèƒ½**ï¼šè·å–ç”¨æˆ·çš„è¯Šæ–­å†å²è®°å½•ï¼ˆåˆ†é¡µï¼‰
- **è¾“å…¥å‚æ•°**ï¼š
  ```javascript
  {
    userId: String,
    pageSize: Number,  // é»˜è®¤10
    pageNum: Number    // é»˜è®¤1
  }
  ```
- **è¿”å›æ•°æ®**ï¼š
  ```javascript
  {
    code: 0,
    message: 'æŸ¥è¯¢æˆåŠŸ',
    data: {
      records: Array,  // è®°å½•åˆ—è¡¨
      total: Number,   // æ€»æ•°
      pageNum: Number,
      pageSize: Number,
      hasMore: Boolean
    }
  }
  ```

#### getDiagnosisDetail
- **è·¯å¾„**ï¼š`uniCloud-aliyun/cloudfunctions/getDiagnosisDetail/index.js`
- **åŠŸèƒ½**ï¼šè·å–å•ä¸ªè¯Šæ–­è®°å½•çš„è¯¦ç»†ä¿¡æ¯
- **è¾“å…¥å‚æ•°**ï¼š
  ```javascript
  {
    diagnosisId: String,
    userId: String  // å¯é€‰ï¼Œç”¨äºæƒé™éªŒè¯
  }
  ```

### 2. å‰ç«¯åŠŸèƒ½æ›´æ–°

#### è¯Šæ–­è®°å½•ä¿å­˜
- âœ… è°ƒç”¨äº‘å‡½æ•°ä¿å­˜åˆ°æ•°æ®åº“
- âœ… æ”¯æŒå›¾ç‰‡ä¸Šä¼ åˆ°äº‘å­˜å‚¨
- âœ… ä¿å­˜æˆåŠŸåè¯¢é—®æ˜¯å¦åˆ›å»ºåº·å¤è®¡åˆ’
- âœ… å…³è”è¯Šæ–­è®°å½•å’Œåº·å¤è®¡åˆ’

#### å†å²è®°å½•åŠ è½½
- âœ… é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è·å–å†å²è®°å½•
- âœ… æ¯æ¬¡æ˜¾ç¤ºé¡µé¢æ—¶åˆ·æ–°æ•°æ®
- âœ… æ ¼å¼åŒ–æ˜¾ç¤ºæ—¶é—´å’Œç»“æœ
- âœ… æ˜¾ç¤ºæ˜¯å¦å·²åˆ›å»ºåº·å¤è®¡åˆ’

### 3. æ•°æ®åº“é›†åˆ

#### diagnosis_recordsï¼ˆè¯Šæ–­è®°å½•ï¼‰
```javascript
{
  _id: String,
  userId: String,
  diagnosisType: String,
  imageUrl: String,
  diagnosisStage: String,      // I/II/III/IV
  confidence: Number,
  diagnosisResult: Array,      // è¯Šæ–­é¡¹ç›®
  analysis: String,            // åˆ†æè¯´æ˜
  suggestion: String,          // å»ºè®®
  allCategories: Array,        // æ‰€æœ‰ç±»åˆ«è¯„åˆ†
  createdAt: Date,
  updatedAt: Date,
  hasRehabPlan: Boolean,       // æ˜¯å¦å·²åˆ›å»ºåº·å¤è®¡åˆ’
  rehabPlanId: String          // å…³è”çš„åº·å¤è®¡åˆ’ID
}
```

---

## ğŸš€ éƒ¨ç½²æ­¥éª¤

### 1. ä¸Šä¼ äº‘å‡½æ•°

åœ¨ HBuilderX ä¸­ï¼š
```
å³é”® uniCloud-aliyun/cloudfunctions/saveDiagnosisRecord â†’ ä¸Šä¼ éƒ¨ç½²
å³é”® uniCloud-aliyun/cloudfunctions/getDiagnosisHistory â†’ ä¸Šä¼ éƒ¨ç½²
å³é”® uniCloud-aliyun/cloudfunctions/getDiagnosisDetail â†’ ä¸Šä¼ éƒ¨ç½²
```

### 2. åˆ›å»ºæ•°æ®åº“é›†åˆ

ç™»å½• uniCloud Web æ§åˆ¶å°ï¼š

1. åˆ›å»º `diagnosis_records` é›†åˆ
2. æ·»åŠ ç´¢å¼•ï¼ˆå»ºè®®ï¼‰ï¼š
   - `userId` (å‡åº)
   - `createdAt` (é™åº)
   - `diagnosisStage` (å‡åº)

### 3. æµ‹è¯•åŠŸèƒ½

#### æµ‹è¯•ä¿å­˜åŠŸèƒ½
1. è¿›å…¥å›¾åƒè¯Šæ–­é¡µé¢
2. ä¸Šä¼ MRIå›¾åƒ
3. ç‚¹å‡»"å¼€å§‹è¯Šæ–­"
4. è¯Šæ–­å®Œæˆåç‚¹å‡»"ä¿å­˜ç»“æœ"
5. æŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—ï¼Œç¡®è®¤ä¿å­˜æˆåŠŸ
6. åœ¨ uniCloud æ§åˆ¶å°æŸ¥çœ‹æ•°æ®åº“è®°å½•

#### æµ‹è¯•å†å²è®°å½•
1. è¿”å›è¯Šæ–­é¦–é¡µ
2. æŸ¥çœ‹"è¯Šæ–­å†å²"åŒºåŸŸ
3. åº”æ˜¾ç¤ºåˆšæ‰ä¿å­˜çš„è®°å½•
4. ç‚¹å‡»è®°å½•æŸ¥çœ‹è¯¦æƒ…ï¼ˆåŠŸèƒ½å¾…å®Œå–„ï¼‰

---

## ğŸ“Š æ•°æ®æµç¨‹

### å®Œæ•´è¯Šæ–­æµç¨‹

```
ä¸Šä¼ å›¾åƒ 
  â†“
è°ƒç”¨APIè¯Šæ–­ 
  â†“
æ˜¾ç¤ºè¯Šæ–­ç»“æœ 
  â†“
ç‚¹å‡»"ä¿å­˜ç»“æœ" 
  â†“
â‘  ä¸Šä¼ å›¾ç‰‡åˆ°äº‘å­˜å‚¨ï¼ˆå¯é€‰ï¼‰
  â†“
â‘¡ è°ƒç”¨saveDiagnosisRecordä¿å­˜
  â†“
â‘¢ è·å¾—diagnosisId
  â†“
â‘£ è¯¢é—®æ˜¯å¦åˆ›å»ºåº·å¤è®¡åˆ’
  â†“
â‘¤ åˆ›å»ºåº·å¤è®¡åˆ’ï¼ˆå¯é€‰ï¼‰
  â†“
â‘¥ æ›´æ–°è¯Šæ–­è®°å½•ï¼ˆhasRehabPlan=trueï¼‰
```

### å†å²è®°å½•åŠ è½½

```
æ‰“å¼€è¯Šæ–­é¡µé¢
  â†“
onLoad() / onShow()
  â†“
è°ƒç”¨getDiagnosisHistory
  â†“
æ ¼å¼åŒ–æ•°æ®
  â†“
æ˜¾ç¤ºåœ¨é¡µé¢
```

---

## ğŸ”— åŠŸèƒ½å…³è”

### è¯Šæ–­è®°å½• â†” åº·å¤è®¡åˆ’

å½“ç”¨æˆ·ä»è¯Šæ–­è®°å½•åˆ›å»ºåº·å¤è®¡åˆ’æ—¶ï¼š

1. **è¯Šæ–­è®°å½•æ›´æ–°**ï¼š
   ```javascript
   {
     hasRehabPlan: true,
     rehabPlanId: "plan_xxx"
   }
   ```

2. **åº·å¤è®¡åˆ’åˆ›å»º**ï¼š
   ```javascript
   {
     diagnosisId: "diagnosis_xxx",
     diagnosisStage: "II",
     ...
   }
   ```

3. **åŒå‘å…³è”**ï¼š
   - ä»è¯Šæ–­è®°å½•å¯ä»¥æŸ¥çœ‹å…³è”çš„åº·å¤è®¡åˆ’
   - ä»åº·å¤è®¡åˆ’å¯ä»¥å›æº¯è¯Šæ–­è®°å½•

---

## ğŸ’¡ ä½¿ç”¨åœºæ™¯

### åœºæ™¯1ï¼šé¦–æ¬¡è¯Šæ–­
```
ç”¨æˆ·ä¸Šä¼ MRI â†’ è¯Šæ–­ä¸ºIIæœŸ â†’ ä¿å­˜è®°å½• â†’ 
åˆ›å»ºåº·å¤è®¡åˆ’ â†’ è®°å½•æ ‡è®°å·²åˆ›å»ºè®¡åˆ’
```

### åœºæ™¯2ï¼šæŸ¥çœ‹å†å²
```
ç”¨æˆ·æ‰“å¼€è¯Šæ–­é¡µé¢ â†’ æ˜¾ç¤ºå†å²è®°å½•åˆ—è¡¨ â†’ 
ç‚¹å‡»è®°å½•æŸ¥çœ‹è¯¦æƒ… â†’ å¯æŸ¥çœ‹å…³è”çš„åº·å¤è®¡åˆ’
```

### åœºæ™¯3ï¼šé‡å¤è¯Šæ–­
```
ç”¨æˆ·å†æ¬¡ä¸Šä¼ MRI â†’ æ–°çš„è¯Šæ–­ç»“æœ â†’ 
ä¿å­˜æ–°è®°å½• â†’ å†å²åˆ—è¡¨æ–°å¢ä¸€æ¡
```

---

## ğŸ“ æ•°æ®åº“å­—æ®µè¯´æ˜

### diagnosis_records é›†åˆ

| å­—æ®µ | ç±»å‹ | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|------|
| userId | String | ç”¨æˆ·ID | "user_123" |
| diagnosisType | String | è¯Šæ–­ç±»å‹ | "éª¨å…³èŠ‚ç‚MRI" |
| imageUrl | String | å›¾åƒURL | "cloud://xxx.jpg" |
| diagnosisStage | String | åˆ†æœŸ | "II" |
| confidence | Number | ç½®ä¿¡åº¦ | 0.95 |
| diagnosisResult | Array | è¯Šæ–­é¡¹ç›® | [{ name, value }] |
| analysis | String | åˆ†æè¯´æ˜ | "æ ¸ç£å…±æŒ¯å›¾åƒæ˜¾ç¤º..." |
| suggestion | String | å»ºè®® | "å»ºè®®è¿›è¡Œ..." |
| allCategories | Array | æ‰€æœ‰ç±»åˆ« | [{ id, score }] |
| hasRehabPlan | Boolean | å·²åˆ›å»ºè®¡åˆ’ | false |
| rehabPlanId | String | è®¡åˆ’ID | "plan_xxx" |
| createdAt | Date | åˆ›å»ºæ—¶é—´ | 2025-10-23 |
| updatedAt | Date | æ›´æ–°æ—¶é—´ | 2025-10-23 |

---

## âš™ï¸ é…ç½®é€‰é¡¹

### å›¾ç‰‡ä¸Šä¼ é…ç½®

é»˜è®¤æƒ…å†µä¸‹ï¼Œç³»ç»Ÿä¼šå°è¯•å°†æœ¬åœ°ä¸´æ—¶å›¾ç‰‡ä¸Šä¼ åˆ°äº‘å­˜å‚¨ï¼š

```javascript
// åœ¨ saveDiagnosis() ä¸­
if (this.imageUrl && this.imageUrl.startsWith('http://tmp/')) {
  const uploadRes = await uniCloud.uploadFile({
    filePath: this.imageUrl,
    cloudPath: `diagnosis/${userInfo.userId}/${Date.now()}.jpg`
  });
  cloudImageUrl = uploadRes.fileID;
}
```

**ä¿®æ”¹å­˜å‚¨è·¯å¾„**ï¼š
```javascript
cloudPath: `your-path/${Date.now()}.jpg`
```

### åˆ†é¡µé…ç½®

é»˜è®¤æ¯é¡µæ˜¾ç¤º10æ¡è®°å½•ï¼š

```javascript
// åœ¨ loadDiagnosisHistory() ä¸­
pageSize: 10,
pageNum: 1
```

**ä¿®æ”¹åˆ†é¡µå¤§å°**ï¼š
```javascript
pageSize: 20  // æ¯é¡µ20æ¡
```

---

## ğŸ”§ åç»­ä¼˜åŒ–å»ºè®®

1. **å†å²è®°å½•è¯¦æƒ…é¡µ**
   - åˆ›å»ºç‹¬ç«‹é¡µé¢æ˜¾ç¤ºå®Œæ•´è¯Šæ–­ä¿¡æ¯
   - æ”¯æŒæŸ¥çœ‹å…³è”çš„åº·å¤è®¡åˆ’
   - æ”¯æŒåˆ†äº«è¯Šæ–­æŠ¥å‘Š

2. **æ‰¹é‡æ“ä½œ**
   - åˆ é™¤å†å²è®°å½•
   - å¯¼å‡ºè¯Šæ–­æŠ¥å‘Š
   - å¯¹æ¯”ä¸åŒæ—¶é—´çš„è¯Šæ–­

3. **æ•°æ®ç»Ÿè®¡**
   - ç»Ÿè®¡è¯Šæ–­æ¬¡æ•°
   - åˆ†æç—…æƒ…å˜åŒ–è¶‹åŠ¿
   - ç”Ÿæˆå¥åº·æŠ¥å‘Š

4. **äº‘å­˜å‚¨ä¼˜åŒ–**
   - å‹ç¼©ä¸Šä¼ çš„å›¾ç‰‡
   - æ¸…ç†è¿‡æœŸå›¾ç‰‡
   - CDNåŠ é€Ÿè®¿é—®

---

## ğŸ“Š æ•°æ®ç»Ÿè®¡

| æ–‡ä»¶ç±»å‹ | æ•°é‡ | ä»£ç è¡Œæ•° |
|---------|------|---------|
| äº‘å‡½æ•°   | 3    | ~200è¡Œ  |
| å‰ç«¯æ›´æ–° | 1    | ~150è¡Œ  |
| æ–‡æ¡£     | 1    | ~400è¡Œ  |
| **æ€»è®¡** | **5** | **~750è¡Œ** |

---

## âœ… å®ŒæˆçŠ¶æ€

âœ… äº‘å‡½æ•°å·²åˆ›å»ºå¹¶å¯éƒ¨ç½²  
âœ… å‰ç«¯ä¿å­˜åŠŸèƒ½å·²é›†æˆ  
âœ… å†å²è®°å½•åŠ è½½å·²å®ç°  
âœ… è¯Šæ–­-åº·å¤å…³è”å·²å»ºç«‹  
âœ… æ–‡æ¡£å·²å®Œå–„  

**åŠŸèƒ½å·²å®Œæ•´å®ç°ï¼Œå¯ä»¥ç«‹å³éƒ¨ç½²ä½¿ç”¨ï¼**

---

**å¼€å‘æ—¶é—´**ï¼š2025-10-23  
**ç‰ˆæœ¬**ï¼šv1.0.0  
**é…å¥—åŠŸèƒ½**ï¼šåº·å¤è®­ç»ƒæ‰“å¡ç³»ç»Ÿ
