# 微信步数功能测试指南

## 测试前准备

### 1. 确认配置
- [x] manifest.json 中已配置 AppID: `wx121837575fd549e6`
- [x] manifest.json 中已添加微信运动权限 `scope.werun`
- [x] wechatLogin 云函数已上传到 uniCloud
- [x] 已移除所有模拟数据逻辑

### 2. 环境要求
- 必须在微信小程序真机环境或微信开发者工具中测试
- 需要用户授权微信运动权限
- 需要手机安装微信，并有微信运动数据

## 测试步骤

### 第一步：微信登录测试

1. 打开小程序，进入"我的"页面
2. 点击"登录 / 注册"按钮
3. 点击"微信一键登录"按钮
4. **预期结果**：
   - 登录成功，显示用户信息
   - 显示"普通会员"，有效期为"永久有效"
   - 显示健康数据卡片

### 第二步：微信步数授权测试

1. 登录成功后，在"我的"页面
2. 点击"同步数据"按钮
3. **第一次使用时**，系统会弹出授权提示
4. 点击"允许"授权微信运动
5. **预期结果**：
   - 授权成功，开始同步数据

### 第三步：步数数据同步测试

1. 授权后，系统自动开始同步
2. **预期结果**：
   - 显示"同步中..."提示
   - 同步成功后显示"同步成功"
   - 步数数据更新显示（例如：8,432）
   - 其他健康数据显示为 0（睡眠、心率、血压）

### 第四步：本地缓存验证

1. 在微信开发者工具的"Storage"标签中查看
2. 应该能看到以下键值：
   - `healthData`: 包含步数等健康数据
   - `lastHealthSyncTime`: 最后同步时间戳
   - `token`: 登录令牌
   - `userInfo`: 用户信息

**healthData 内容示例**：
```json
{
  "steps": "8,432",
  "sleepHours": "0",
  "heartRate": "0",
  "bloodPressure": "0/0"
}
```

### 第五步：自动同步测试

1. 关闭小程序
2. 等待24小时后重新打开
3. 进入"我的"页面
4. **预期结果**：
   - 系统自动静默同步步数（不显示加载提示）
   - 步数数据自动更新

## 常见问题排查

### 问题1：点击"同步数据"无反应

**可能原因**：
- 不在微信环境中
- 未授权微信运动权限

**解决方法**：
1. 确认在微信小程序中运行（不是 H5 或其他环境）
2. 检查控制台日志，查看具体错误信息
3. 尝试重新授权微信运动

**控制台日志检查**：
```javascript
// 应该看到这些日志
当前平台: mp-weixin
开始获取微信运动数据...
微信运动数据获取成功: {...}
获取到步数: 8432
```

### 问题2：步数显示为 0

**可能原因**：
- 今天还没有微信运动数据
- 微信运动返回了加密数据（需要云函数解密）
- 微信运动未授权

**解决方法**：
1. 确认微信运动中有今日步数
2. 检查控制台日志，查看 `wx.getWeRunData()` 的返回值
3. 如果返回 `encryptedData`，说明需要通过云函数解密

**日志示例**：
```javascript
// 直接返回步数（无需解密）
{
  stepInfoList: [
    { timestamp: 1445866601, step: 100 }
  ]
}

// 返回加密数据（需要解密）
{
  encryptedData: "...",
  iv: "..."
}
```

### 问题3：提示"请授权微信运动权限"

**解决方法**：
1. 删除小程序，重新打开
2. 点击"同步数据"按钮
3. 在弹出的授权提示中点击"允许"
4. 如果已拒绝授权，需要：
   - 微信中搜索小程序
   - 长按小程序图标
   - 选择"设置"
   - 找到"微信运动"权限
   - 重新授权

### 问题4：提示"需要通过云函数解密步数数据"

**原因**：
- 微信返回了加密的步数数据，无法直接使用

**解决方法**：
需要实现完整的解密流程（当前版本暂不支持），包括：
1. 登录时保存 sessionKey
2. 调用 decryptWechatSteps 云函数
3. 传递 encryptedData、iv、sessionKey 进行解密

**临时方案**：
- 目前只能获取微信直接返回的 stepInfoList
- 如果微信返回加密数据，步数会显示为 0

## 测试检查清单

### 功能测试
- [ ] 微信登录成功
- [ ] 显示"普通会员"和"永久有效"
- [ ] 健康数据卡片正常显示
- [ ] 点击"同步数据"能触发同步
- [ ] 微信运动授权流程正常
- [ ] 步数数据正确显示并格式化（如：8,432）
- [ ] 其他健康数据显示为 0
- [ ] 同步成功后显示提示

### 数据测试
- [ ] 步数数据保存到本地缓存
- [ ] 同步时间戳正确保存
- [ ] 重新打开小程序数据仍然存在
- [ ] 超过24小时自动触发同步
- [ ] 手动同步能更新数据

### 错误处理测试
- [ ] 未登录时不显示健康数据卡片
- [ ] 未授权微信运动时显示错误提示
- [ ] 网络错误时显示友好提示
- [ ] 同步失败时返回本地缓存数据

## 成功标准

所有以下条件都满足，说明功能正常：

1. ✅ 微信登录成功，显示用户信息
2. ✅ VIP 显示"普通会员 - 永久有效"
3. ✅ 点击"同步数据"能获取到步数
4. ✅ 步数数据正确显示并格式化
5. ✅ 数据保存到本地缓存
6. ✅ 重启小程序数据持久化
7. ✅ 自动同步机制正常工作
8. ✅ 错误提示清晰友好

## 下一步优化

### 短期优化（可选）
1. 实现完整的微信步数解密功能
2. 添加数据图表展示
3. 添加历史数据查看

### 长期优化（需要申请 API）
1. 接入小米健康 API（睡眠、心率、血压）
2. 接入华为健康 API（睡眠、心率、血压）
3. 实现多数据源整合
4. 添加健康数据分析功能

## 注意事项

1. **只在微信小程序环境测试**：不要在 H5 或其他环境测试，会报错
2. **真机测试更准确**：开发者工具可能无法完全模拟微信运动 API
3. **检查控制台日志**：所有关键步骤都有详细日志输出
4. **注意授权状态**：首次使用需要授权，拒绝后需要手动重新授权
5. **数据更新时间**：微信运动数据可能有延迟，不是实时的

---

**如有问题，请查看控制台日志获取详细错误信息！**

*最后更新: 2023年12月*
