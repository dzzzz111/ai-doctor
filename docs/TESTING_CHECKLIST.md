# 康复打卡功能测试清单

## 📋 测试前准备

### 环境检查
- [ ] HBuilderX 已安装并打开项目
- [ ] 微信开发者工具已安装
- [ ] uniCloud 服务空间已创建并关联
- [ ] 小程序AppID已配置（manifest.json）

### 部署检查
- [ ] 4个云函数已上传部署
  - [ ] initRehabVideos
  - [ ] createRehabPlan
  - [ ] getRehabPlan
  - [ ] trainingCheckIn
- [ ] 4个数据库集合已创建
  - [ ] rehabilitation_videos
  - [ ] rehabilitation_plans
  - [ ] training_check_ins
  - [ ] user_rehabilitation_profiles

---

## 🧪 测试流程

### 测试 1：视频管理功能

#### 1.1 访问视频管理页面
```
操作步骤：
1. 在微信开发者工具运行小程序
2. 在页面路径栏输入：pages/admin/init-videos
3. 按回车访问
```

**预期结果**：
- [x] 页面正常加载
- [x] 显示"视频管理"标题
- [x] 显示"快速初始化"按钮
- [x] 显示"添加抖音视频"表单

#### 1.2 初始化示例视频
```
操作步骤：
1. 点击"初始化示例视频数据"按钮
2. 等待提示
```

**预期结果**：
- [x] 显示"初始化成功"提示
- [x] 自动刷新视频列表
- [x] 显示3个示例视频

**验证数据库**：
- 在 uniCloud 控制台查看 `rehabilitation_videos` 集合
- 应该有3条记录

#### 1.3 添加抖音视频
```
操作步骤：
1. 填写视频标题："膝关节康复训练 - I期测试"
2. 填写描述："测试用视频"
3. 选择"抖音链接"
4. 粘贴抖音分享链接（随便找一个）
5. 时长：300
6. 难度：简单
7. 类别：柔韧性
8. 分期：勾选 I期
9. 点击"添加视频"
```

**预期结果**：
- [x] 显示"添加成功"提示
- [x] 表单自动重置
- [x] 视频列表自动刷新
- [x] 新视频出现在列表中

**验证数据库**：
- 在数据库中应该能看到刚添加的视频
- `videoUrl` 字段应该是抖音链接
- `targetStage` 应该是 `["I"]`

---

### 测试 2：诊断和计划创建

#### 2.1 完成MRI诊断
```
操作步骤：
1. 小程序首页 → 点击"图像诊断"
2. 点击"选择图片"
3. 选择任意图片（测试用）
4. 点击"开始诊断"
5. 等待诊断结果
6. 点击"保存结果"
```

**预期结果**：
- [x] 显示诊断分期（I/II/III/IV）
- [x] 显示诊断描述和建议
- [x] 保存成功提示
- [x] 弹出"是否创建康复训练计划"对话框

#### 2.2 创建康复计划
```
操作步骤：
1. 诊断保存后，点击"立即创建"
2. 等待创建完成
```

**预期结果**：
- [x] 显示创建成功提示
- [x] 自动跳转到康复训练页面（/pagesA/rehabilitation/index）
- [x] 页面显示训练计划信息

**验证数据库**：
- `diagnosis_records` 集合应该有新记录
  - `hasRehabPlan` 为 `true`
- `rehabilitation_plans` 集合应该有新记录
  - `videoIds` 数组包含推荐的视频ID
  - `weeklyGoal` 根据分期设置
- `user_rehabilitation_profiles` 集合应该有用户档案

---

### 测试 3：康复训练页面

#### 3.1 查看训练计划
```
操作步骤：
1. 确保已在康复训练页面
2. 查看页面各部分
```

**预期结果**：
- [x] **进度卡片**显示：
  - 分期徽章（如"I期康复"）
  - 当前周次（如"第 1/12 周"）
  - 进度条（如"8%"）
  - 本周打卡：0次
  - 累计打卡：0次
  - 连续天数：0天

- [x] **本周训练**显示：
  - "推荐每周训练 X 次"提示
  - 视频列表（根据分期显示4-8个视频）
  - 每个视频显示：
    - 缩略图
    - 视频标题
    - 难度标签
    - 类别标签
    - 视频描述

- [x] **康复目标**显示：
  - 根据分期显示3-4个目标
  - 每个目标有图标和文字

#### 3.2 测试从首页入口访问
```
操作步骤：
1. 返回首页（tabbar"首页"）
2. 向下滚动
3. 找到绿色的"个性化康复训练"横幅
4. 点击横幅
```

**预期结果**：
- [x] 跳转到康复训练页面
- [x] 显示之前创建的训练计划

---

### 测试 4：视频播放和打卡

#### 4.1 播放视频
```
操作步骤：
1. 在康复训练页面，点击任意视频卡片
2. 进入视频播放页面
```

**预期结果**：
- [x] 页面正常加载
- [x] 显示视频播放器
- [x] 显示视频标题和描述
- [x] 显示难度标签和类别标签
- [x] 如果有注意事项，显示黄色警告框
- [x] 底部显示"完成打卡"按钮

**注意**：
- 如果是抖音链接，视频可能无法直接播放
- 这是正常的，因为小程序video组件对外部链接有限制
- 可以使用云存储的视频测试完整播放功能

#### 4.2 尝试立即打卡（应失败）
```
操作步骤：
1. 视频刚加载，不播放或播放很少
2. 直接点击"完成打卡"按钮
```

**预期结果**：
- [x] 弹出提示："请至少完成30%的训练再打卡"
- [x] 打卡面板不显示

#### 4.3 观看30%后打卡
```
操作步骤：
1. 拖动进度条到30%以上
2. 或观看视频到30%
3. 点击"完成打卡"
```

**预期结果**：
- [x] 显示打卡面板（从底部弹出）
- [x] 面板显示：
  - "完成训练打卡"标题
  - 难度感受（5星评分，默认3星）
  - 疼痛程度（5星评分，默认2星）
  - 训练笔记输入框
  - 字符计数（0/200）
  - "取消"和"完成打卡 +10积分"按钮

#### 4.4 填写反馈
```
操作步骤：
1. 点击难度感受星星，选择4星
2. 点击疼痛程度星星，选择1星
3. 在笔记框输入："感觉不错"
```

**预期结果**：
- [x] 星星实时高亮
- [x] 显示对应描述（如"较困难"、"无痛"）
- [x] 字符计数更新（如"4/200"）

#### 4.5 提交打卡
```
操作步骤：
1. 点击"完成打卡 +10积分"按钮
2. 等待提交
```

**预期结果**：
- [x] 显示"打卡中..."加载状态
- [x] 弹出"打卡成功"对话框，内容包括：
  - "+10积分"
  - "连续打卡1天"（如果是第一次打卡）
  - 可能显示解锁的成就
- [x] 点击确定后自动返回康复训练页面

**验证数据库**：
- `training_check_ins` 集合应该有新记录：
  ```javascript
  {
    userId: "test_user_demo",
    planId: "...",
    videoId: "...",
    checkInDate: "2025-10-24...",
    duration: 90,  // 观看时长
    feedback: {
      difficulty: 4,
      painLevel: 1,
      notes: "感觉不错"
    },
    points: 10
  }
  ```

- `rehabilitation_plans` 集合中，对应计划的：
  - `totalCheckIns` 应该增加1

- `user_rehabilitation_profiles` 集合中：
  - `statistics.totalCheckIns` 增加1
  - `statistics.totalPoints` 增加10
  - `statistics.currentStreak` 应该为1

---

### 测试 5：打卡后状态

#### 5.1 查看更新后的进度
```
操作步骤：
1. 在康复训练页面
2. 查看进度卡片
```

**预期结果**：
- [x] 本周打卡：1次
- [x] 累计打卡：1次
- [x] 连续天数：1天

#### 5.2 已打卡视频标记
```
操作步骤：
1. 查看刚才打卡的视频卡片
```

**预期结果**：
- [x] 视频缩略图左上角显示绿色"✓ 已完成"徽章

#### 5.3 测试重复打卡（应失败）
```
操作步骤：
1. 再次点击刚才打卡的视频
2. 观看到30%
3. 点击"完成打卡"
4. 提交打卡
```

**预期结果**：
- [x] 弹出提示："今日已打卡此视频"
- [x] 不增加积分和打卡次数

#### 5.4 打卡不同视频
```
操作步骤：
1. 选择另一个未打卡的视频
2. 重复上述打卡流程
```

**预期结果**：
- [x] 打卡成功
- [x] 本周打卡：2次
- [x] 累计打卡：2次
- [x] 两个视频都显示"已完成"标记

---

### 测试 6：边界情况

#### 6.1 未登录用户
```
操作步骤：
1. 清除登录状态（在个人中心退出登录）
2. 访问康复训练页面
```

**预期结果**：
- [x] 弹出对话框："需要登录"
- [x] 提供"测试模式"和"去登录"选项
- [x] 选择"测试模式"可继续使用
- [x] 选择"去登录"跳转到登录页

#### 6.2 无训练计划
```
操作步骤：
1. 使用新用户（或删除现有计划）
2. 访问康复训练页面
```

**预期结果**：
- [x] 显示空状态页面
- [x] 提示："暂无康复训练计划"
- [x] 提示："完成MRI诊断后，系统将为您生成个性化训练方案"
- [x] 显示"去诊断"按钮
- [x] 点击按钮跳转到图像诊断页面

#### 6.3 无可用视频
```
操作步骤：
1. 在数据库中删除所有 rehabilitation_videos 记录
2. 完成诊断并尝试创建计划
```

**预期结果**：
- [x] 创建计划失败
- [x] 提示："暂无适合的训练视频"
- [x] 不跳转到康复训练页面

---

## ✅ 完整流程验证

### 新用户完整体验流程

1. **添加视频**
   - [ ] 访问视频管理页面
   - [ ] 为I期添加2个视频
   - [ ] 为II期添加2个视频

2. **诊断**
   - [ ] 上传MRI图像
   - [ ] 完成诊断（获得I期或II期）
   - [ ] 保存结果

3. **创建计划**
   - [ ] 点击"立即创建"
   - [ ] 自动跳转到康复训练页面
   - [ ] 确认显示2个推荐视频

4. **第一次打卡**
   - [ ] 点击第一个视频
   - [ ] 观看到30%
   - [ ] 完成打卡
   - [ ] 获得10积分
   - [ ] 连续天数为1

5. **第二次打卡**
   - [ ] 点击第二个视频
   - [ ] 完成打卡
   - [ ] 本周打卡增加到2次

6. **查看进度**
   - [ ] 返回康复训练页面
   - [ ] 确认统计数据正确
   - [ ] 确认两个视频都有"已完成"标记

---

## 🐛 常见问题和解决方案

### 问题1：视频列表为空
**原因**：数据库中没有对应分期的视频  
**解决**：
1. 确认 `rehabilitation_videos` 集合有数据
2. 检查视频的 `targetStage` 字段是否包含诊断分期
3. 检查视频的 `difficulty` 是否符合该分期要求（I期只能是easy）

### 问题2：云函数调用失败
**原因**：云函数未部署或权限问题  
**解决**：
1. 重新上传部署云函数
2. 检查 uniCloud 服务空间是否正确关联
3. 查看云函数日志获取详细错误信息

### 问题3：打卡提交失败
**原因**：数据库集合未创建或字段不匹配  
**解决**：
1. 确认4个数据库集合都已创建
2. 检查集合名称是否完全正确（包括下划线）
3. 查看云函数 `trainingCheckIn` 的日志

### 问题4：视频无法播放
**原因**：抖音链接不支持直接播放  
**解决**：
- 抖音链接仅用于存储，实际播放需要下载视频上传到云存储
- 或使用其他可直接播放的URL
- 测试时可以先不管播放，直接测试打卡功能

---

## 📊 测试数据统计

### 成功标准

- [x] 所有测试用例通过率 ≥ 90%
- [x] 关键流程（诊断→创建计划→打卡）100%通过
- [x] 数据库数据完整且正确
- [x] 无严重bug或崩溃

### 测试报告模板

```markdown
## 测试报告

**测试时间**：2025-10-24  
**测试人员**：[您的名字]  
**测试环境**：
- HBuilderX 版本：
- 微信开发者工具版本：
- 操作系统：

**测试结果**：
- 测试用例总数：30
- 通过数：
- 失败数：
- 通过率：

**问题列表**：
1. [问题描述]
2. [问题描述]

**建议**：
- [改进建议]
```

---

## 🎉 测试完成

恭喜！如果所有测试都通过，说明康复打卡功能已经完全可用。

**下一步**：
1. 准备真实的康复视频内容
2. 邀请测试用户体验
3. 收集反馈优化功能
4. 准备上线部署

---

**文档版本**：v1.0  
**更新时间**：2025-10-24
